name: Upload Operator Images

on:
  workflow_dispatch: {}
  push:
    tags:
      - v*

permissions: read-all

jobs:
  Upload:
    permissions:
      # https://docs.github.com/en/packages/managing-github-packages-using-github-actions-workflows/publishing-and-installing-a-package-with-github-actions#authenticating-to-package-registries-on-github
      packages: write
    strategy:
      matrix:
        arch: [ amd64, arm64 ]
        image:
          [ chaosblade-operator ]
    outputs:
      image_tag: ${{ steps.image_tag.outputs.image_tag }}
    runs-on: ubuntu-20.04
    steps:
      - name: Extract Image Tag
        id: image_tag
        shell: bash
        run: |
          IMAGE_TAG=${GITHUB_REF##*/}
          echo "::set-output name=image_tag::$(echo $IMAGE_TAG)"

      - name: Login to GitHub Container registry
        uses: docker/login-action@v1
        with:
          registry: chaosbladeio
          username: ${{ secrets.DOCKER_HUB_USER }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Build Image
        run:
          - make docker-build
          - make docker-build-arm64

      - name: Upload Image
        env:
          IMAGE_TAG: ${{ steps.image_tag.outputs.image_tag }}
          ARCH: ${{ matrix.arch }}
          IMAGE: ${{ matrix.image }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        run: |
          # ${VAR,,} convert VAR to lower case
          - docker push chaosbladeio/${GITHUB_REPOSITORY_OWNER,,}/$IMAGE:$IMAGE_TAG
          - docker push chaosbladeio/${GITHUB_REPOSITORY_OWNER,,}/$IMAGE:$IMAGE_TAG-arm64

#      - name: Build and push Docker images
#        uses: docker/build-push-action@v3.2.0
